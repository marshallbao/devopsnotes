# 日志

### 操作日志（oplog）

`oplog` 全称 **operations log（操作日志）**，是 MongoDB **复制集（Replica Set）** 中的核心组件。

- 它是一个 **循环日志（capped collection）**，存储在 `local` 数据库中 local.oplog.rs

- 记录了 **主节点（primary）上所有写操作**（insert、update、delete、command）。
- 副本节点（secondary）通过读取 oplog 来**同步主节点的数据变化**。

Oplog 的存储和大小

- Oplog 是一个 **固定大小的循环集合（capped collection）**。
- 默认大小：
  - 小于 1GB 内存的副本集：`5%` 内存大小
  - 大于 1GB 内存的副本集：`50MB` + 0.5 × RAM
- 当 oplog 满了，最旧的记录会被覆盖（FIFO）。
- 因此，副本节点必须在 oplog 覆盖之前完成追赶，否则可能需要全量 resync。



```
# 查看 oplog 大小
use local
db.oplog.rs.stats()

# 查看 oplog 滚动速度
rs.printReplicationInfo()
```



### 审计日志

配置

```
auditLog:
   destination: file
   format: JSON
   path: /var/log/mongodb/auditLog.json
   filter: '{"atype":{"$in":["authenticate","createCollection","createDatabase","createIndex","renameCollection","dropCollection","dropDatabase","dropIndex","createUser","dropUser","updateUser","grantRolesToUser","revokeRolesFromUser","shutdown"]}}'
setParameter: { auditAuthorizationSuccess: true }
```



### 系统日志





### 参考

https://www.mongodb.com/docs/v4.4/core/auditing/

https://www.mongodb.com/docs/v4.4/reference/audit-message/

