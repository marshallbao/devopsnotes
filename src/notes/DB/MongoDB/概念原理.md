# MongoDB 原理

## 一、MongoDB 的存储引擎

MongoDB 的存储方式依赖 **存储引擎**（Storage Engine）：

1. **WiredTiger（默认，自 3.2 起）**
   - 目前主流 MongoDB 默认的引擎。
   - 特点：文档级锁（document-level lock）、压缩存储、并发控制强。
2. **MMAPv1（旧引擎，已弃用）**
   - 早期的 MongoDB 引擎，基于内存映射文件（memory-mapped files）。
   - 已经在新版中移除。

👉 所以，现在说 MongoDB 底层存储，基本就是在说 **WiredTiger**。

------

## 🔹 二、数据存储格式

MongoDB 对外存储的是 **文档（Document，类似 JSON）**，但底层并不是直接存 JSON，而是用 **BSON（Binary JSON）**。

- **BSON** 特点：
  - 二进制存储，更紧凑，支持快速解析。
  - 支持额外类型（如 `Date`、`ObjectId`），JSON 没有的。
  - 文档 = 键值对（类似字典 / Map），值可以是标量、数组、嵌套文档。
- **磁盘存储**：
  - 数据文件（`.wt` 文件，WiredTiger 格式）。
  - 日志文件（`.turtle` / `.log`），用于崩溃恢复。

------

## 🔹 三、数据组织结构

WiredTiger 使用 **B+ 树（B+ Tree）** 来存储集合（Collection）和索引。

1. **集合（Collection）**
   - 每个集合存储在一个 B+ 树中。
   - 叶子节点存放 BSON 文档，内部节点存放键和指针。
2. **索引（Index）**
   - 默认 `_id` 字段有唯一索引。
   - 索引同样是 **B+ 树结构**（和 MySQL 类似）。
   - 支持哈希索引、复合索引、地理空间索引（R 树变种）。
3. **压缩**
   - WiredTiger 会对数据页进行压缩（Snappy/Zlib/Zstd），减少存储空间和 I/O。

------

## 🔹 四、内存管理

- WiredTiger 使用 **页（Page）** 作为基本单位（和关系型数据库类似）。
  - 数据页（Data Page）：存放 BSON 文档。
  - 索引页（Index Page）：存放索引键值和指针。
- 页大小默认 4KB（可配置）。
- 内存中有缓存池（类似 MySQL Buffer Pool），常用数据页会缓存在内存中，减少磁盘 I/O。

------

## 🔹 五、日志与事务

- **Write Ahead Logging (WAL)**：采用日志先行的方式（类似 MySQL Redo Log）。
- **Checkpoint**：定期将内存数据刷新到磁盘。
- **MVCC（多版本并发控制）**：
  - 支持快照读，避免读写冲突。
  - 底层通过 **记录版本号 + Undo 机制** 来实现。

------

## 🔹 六、总结

MongoDB 底层存储的关键点：

- **数据格式**：BSON（二进制 JSON，支持更多类型）
- **存储引擎**：WiredTiger（B+ 树存储 + 压缩 + WAL 日志）
- **索引结构**：B+ 树为主，支持哈希索引、地理空间索引
- **存储单元**：页（Page，默认 4KB）
- **事务机制**：MVCC + WAL 日志 + Checkpoint