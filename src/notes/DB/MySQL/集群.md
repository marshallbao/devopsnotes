# 集群

### 主从同步





### MySQL Group Replication

MySQL Group Replication 是 MySQL 官方提供的一种高可用集群解决方案，它通过使用 **Paxos 协议** 来实现多个 MySQL 实例之间的强一致性。MySQL Group Replication (MGR) 允许在多个节点之间进行 **自动故障转移**，**读写分离**，并确保在集群内的数据一致性。

#### 主要特性

1.1. 多主模式和单主模式
单主模式（Single-Primary Mode）：只有一个节点作为主节点，其他节点是只读的。所有写操作都会在主节点上进行，而其他节点会作为只读副本（读取操作可以在所有节点上进行）。

多主模式（Multi-Primary Mode）：集群中的所有节点都可以进行写操作。数据会通过组内协议保证所有节点之间的一致性，这对于高写负载的应用来说非常重要。

1.2. 强一致性
MySQL Group Replication 使用 Paxos 协议来确保所有节点的数据一致性。所有事务的提交都需要集群内的多数节点同意，保证了数据的一致性。

在 多主模式 下，所有写操作都可以发生在任意一个节点，但只有在多数节点确认该事务时，它才能被提交。这确保了即使某些节点失败，集群依然能继续运行，并且数据一致性得到保证。

1.3. 自动故障转移
如果集群中的主节点（在单主模式下）或任何其他节点发生故障，MySQL Group Replication 会自动选举一个新的主节点（在单主模式下），并且能够在不影响服务的情况下恢复。

集群内的节点能够自动感知故障并进行恢复，无需人工干预。

1.4. 数据分配和负载均衡
读写分离：在单主模式下，写操作只能在主节点执行，但读操作可以分发到集群中的任意节点上。这样可以在读负载较高时分散负载。

在多主模式下，所有节点均可读写操作，集群能够分担读写压力。

1.5. 分布式事务支持
MySQL Group Replication 采用 全局事务标识符（GTID），使得集群能够保持一致的事务处理和同步。

支持跨节点的事务执行，确保集群内的数据一致性。

#### 架构与工作原理

2.1. Paxos 协议
MySQL Group Replication 使用 Paxos 协议 来达成集群中的共识。在每个事务提交之前，必须由 多数节点 对该事务达成一致（也就是说，写入必须在大多数节点上完成才能被认为成功）。这个过程确保了数据的一致性，即使在出现节点故障或网络分区时也不会导致数据不一致。

Paxos协议 通过在多个节点之间选举 主节点 来避免“脑裂”现象（split-brain）。如果主节点宕机，Paxos 协议会自动选举出新的主节点。

2.2. 成员节点与组内通信
每个节点在 Group Replication 中都是 成员节点，每个成员节点都持有相同的数据副本。

节点之间通过 组内协议（Group Communication Protocol，简称 GCP）进行通信，传递事务和日志。

节点之间的数据同步通过 流复制（streaming replication） 实现。每个节点接收来自其他节点的事务信息，并确保在本地应用这些事务。

2.3. 事务日志
每个节点都维护一个事务日志，记录所有提交的事务。事务日志被用于同步和回放未确认的事务。

所有节点会在提交事务前交换事务日志，以确保所有节点的事务顺序一致。

### MySQL NDB Cluster

MySQL NDB Cluster 是 MySQL 提供的一种高可用、分布式的数据库集群解决方案，专为高性能、大规模和低延迟的场景设计。它采用 **无共享架构**，能够实现数据的 **自动分片** 和 **容错性**，并通过 **NDB 存储引擎** 提供对分布式数据的高效访问。

#### 主要特性

1.1. 高可用性
节点冗余与容错：MySQL NDB Cluster 采用 多副本复制 和 数据冗余 的方式，确保数据的高可用性。每个数据片的副本会分布在不同的节点上。如果一个节点发生故障，其他节点会接管工作，保证数据不会丢失。

自动故障转移：如果某个数据节点或管理节点发生故障，系统会自动进行故障转移。集群会选择一个新的数据节点或管理节点，并确保所有数据副本在其他节点上可用。

1.2. 数据分片
数据被分为多个 分片（shards），每个分片存储一部分数据。分片策略是 哈希分片，通过哈希函数将数据分布到不同的节点上。

每个分片有多个副本，确保即使某个副本节点故障，数据仍然可用。

1.3. 高性能与低延迟
NDB Cluster 主要通过 内存存储 来提供 高速访问，尤其适合需要低延迟和高吞吐量的应用。

支持 内存数据存储，数据以行存储在内存中，减少了磁盘访问的延迟。

1.4. 扩展性
水平扩展：MySQL NDB Cluster 可以通过添加更多的数据节点或管理节点来进行水平扩展，以满足 大数据量和高并发 的需求。

通过增加更多的节点，集群可以处理更多的读写请求，支持弹性扩展。

1.5. 事务一致性
支持 ACID 事务，通过 两阶段提交（2PC） 确保事务的原子性、一致性、隔离性和持久性。

使用 分布式锁机制 来避免事务冲突，保证分布式环境下的事务一致性。

#### 架构与工作原理

2.1. 集群架构
MySQL NDB Cluster 的架构由以下几个主要组件组成：

数据节点（Data Nodes）：

存储实际的数据，并且执行数据的读写操作。每个数据节点负责多个分片的存储。

数据节点具有 内存存储 的特性，数据在内存中存储并通过内存访问，以实现 低延迟 和 高吞吐量。

管理节点（Management Nodes）：

负责集群的配置和管理，包括启动和停止节点、监控集群状态、自动故障恢复等。

管理节点不参与数据存储，只处理集群的管理和协调工作。

SQL 节点（SQL Nodes）：

提供 SQL 接口，允许客户端通过 SQL 查询与集群交互。

SQL 节点并不直接存储数据，它们通过与数据节点的连接进行查询和写入操作。

可以是 MySQL 或 MariaDB 实例，SQL 节点主要用于对外提供数据库服务。

2.2. 数据存储与复制
数据存储：NDB Cluster 使用 NDB 存储引擎，数据行被存储在内存中，确保快速的数据访问。每个数据行都有一个唯一的 ID。

数据复制：每个数据分片会有多个副本，通常是 2-3 个副本（主副本和备用副本）。副本分布在不同的 数据节点 上，确保数据的高可用性。

主副本：负责处理所有的读写操作。

备用副本：与主副本保持同步，确保在主副本故障时，能够快速切换。

2.3. 事务和一致性
NDB Cluster 提供 ACID 事务 支持，并确保跨节点的事务一致性。

所有的事务都通过 两阶段提交协议（2PC） 来保证数据一致性和持久性。事务的提交必须等待所有相关数据节点的确认。

支持 分布式事务，可以跨多个数据节点执行事务，保证不同节点间的数据一致性。

2.4. 网络通信与故障恢复
NDB Cluster 使用高速网络来连接各个节点，以确保高效的数据同步和低延迟。

网络故障或节点故障时，NDB Cluster 会自动触发 节点恢复机制，并通过重新选举主副本来恢复数据可用性。









参考

https://docs.percona.com/percona-xtradb-cluster/8.0/index.html