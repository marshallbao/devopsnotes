# 主从复制

主从复制是 Redis 的一种基本集群模式，它通过将一个Redis节点（主节点）的数据复制到一个或多个其他Redis节点（从节点）来实现数据的冗余和备份。

主节点负责处理客户端的写操作，同时从节点会实时同步主节点的数据。客户端可以从从节点读取数据，实现读写分离，提高系统性能。

主从复制模式适合数据备份、读写分离和在线升级等场景，但在主节点故障时需要手动切换，不能自动实现故障转移。如果对高可用性要求较高，可以考虑使用哨兵模式或Cluster模式。

### Sentinel 模式

哨兵模式是在主从复制基础上加入了哨兵节点，实现了自动故障转移。哨兵节点是一种特殊的 Redis 节点，它会监控主节点和从节点的运行状态。当主节点发生故障时，哨兵节点会自动从从节点中选举出一个新的主节点，并通知其他从节点和客户端，实现故障转移。

### Redis Cluster 架构

数据分片（Sharding）

Cluster将数据分散存储在多个节点上，每个节点负责一部分数据。数据分片基于哈希槽（Slot）实现，共有 16384 个槽，每个键通过 CRC16 算法映射到特定槽，槽再分配给集群中的节点。

节点角色

主节点（Master）：负责处理槽对应的读写请求，维护数据副本，并同步给从节点。

从节点（Slave）：复制主节点数据，提供读服务，主节点故障时可晋升为主节点。

节点间通信

Gossip 协议：节点间通过Gossip协议交换集群状态信息，包括节点新增、删除、故障、槽信息变更等。

客户端通信：客户端与任意节点建立连接，节点负责将请求转发至正确的主节点。

#### 原理机制

数据路由

客户端路由：客户端使用MOVED重定向响应或ASK转向请求，自动将请求转发至正确的主节点。

节点间路由：节点通过集群拓扑信息，将不属于本节点的请求转发至目标节点。

故障检测与自动故障转移

心跳检测：节点间定期发送PING/PONG消息，检测对方是否存活。

主观下线与客观下线：类似 Sentinel，节点根据心跳超时判断主观下线，多数节点同意则标记客观下线。

故障转移：故障节点的从节点竞选成为新主节点，其他节点更新槽映射与配置，客户端自动重定向。

数据同步与增量复制

全量同步：新节点加入或从节点晋升为主节点时，通过RDB快照进行全量同步。
增量复制：主从节点间通过PSYNC命令进行增量数据同步，减少网络开销。

#### 简单理解

集群最少由三主三从6个节点组成；当主节点挂掉后，剩余的主节点会投票让从节点变成主节点；

集群也可以任意添加节点，但是最好为奇数，这样可以报证投票的时候能正常投出主节点；

负责某些 hash 槽的主从节点同时挂掉；会导致这些 hash 槽的 key 无法访问；

也就是说3主3从/5主10是合理的；（任意挂掉2个节点集群仍然可以正常工作）





集群与单体 Redis 的区别如下：

1、key 批量操作支持有限：例如 mget、mset 必须在一个 slot ；
2、Key 事务和Lua支持有限：操作的 key 必须在一个节点；
3、key 是数据分区的最小粒度：不支持 bigkey 分区；
4、不支持多个数据库：集群模式下只有一个 db0；
5、复制只支持一层：不支持树形复制结构。





#### 参考

https://www.cnblogs.com/yidengjiagou/p/17345831.html