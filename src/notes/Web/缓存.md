# 缓存

### 浏览器缓存

Web 开发者可以通过 HTTP 头部 来控制浏览器的缓存策略，常用的缓存控制头部包括：

```
# Cache-Control

no-cache：不直接缓存资源，每次都要与服务器进行验证（通过 ETag 或 Last-Modified）。注意：这并不意味着不缓存，而是要求缓存时必须进行验证。（可以理解为协商缓存）

no-store：表示不缓存资源，每次都从服务器请求，不进行任何存储。

public：表示资源可以被任何缓存存储（包括共享缓存和私有缓存）。适用于那些不敏感的静态资源。

private：表示资源只能被用户自己的浏览器缓存，不能由共享缓存（如 CDN）缓存。通常用于用户个性化的内容。

max-age=<seconds>：指定资源可以缓存的最大时间，单位是秒。例如，max-age=3600 表示资源可以在缓存中保存 1 小时。

s-maxage=<seconds>：与 max-age 相似，但是仅适用于共享缓存（如 CDN）。如果同时设置了 max-age 和 s-maxage，s-maxage 优先级更高。

# ETag

ETag 是一种 验证缓存的机制，它是服务器生成的一个独特标识符（通常是文件内容的哈希值或文件的最后修改时间）。浏览器请求时，会在 If-None-Match 头中发送当前缓存的 ETag，如果资源未被修改，服务器会返回 304 状态码，表示资源没有变化，浏览器可以使用缓存。

# Last-Modified

Last-Modified 头部表示资源最后修改的时间。浏览器会在后续请求时通过 If-Modified-Since 头来验证文件是否被修改。如果文件没有变化，服务器会返回 304 状态码，表示缓存有效。
```



#### 关于协商缓存

```
协商缓存的核心 HTTP 头部字段

1. ETag 和 If-None-Match
   - ETag（Entity Tag）是服务器给每个资源生成的唯一标识符，通常是该资源的哈希值或某个版本号。它表示资源的内容或状态。
   - If-None-Match 是浏览器在后续请求中带上的头部，它的值是上次响应中返回的 ETag。服务器根据这个值判断资源是否已经变化。

2. Last-Modified 和 If-Modified-Since
   - Last-Modified 是服务器返回的资源的最后修改时间。浏览器可以根据这个时间来判断资源是否修改过。
   - If-Modified-Since 是浏览器在后续请求中发送的头部，表示资源的上次修改时间。服务器会比较这个时间与当前资源的最后修改时间，判断资源是否发生了变化。

no-cache：是一种缓存控制指令，表示缓存资源需要进行验证，但不一定会重新获取资源。它通过协商缓存来决定是否使用缓存。

协商缓存：是基于 ETag 或 Last-Modified 来验证资源是否发生变化，是 no-cache 实现的一部分，用于确认缓存的有效性。

还有就是它俩的动作都是一样的，只不过目的不一样：

no-cache 强制每次都验证，不管资源是否变化，目的是确保每次都获取最新的资源。

协商缓存 则是为了减少不必要的带宽消耗，只有在资源变化时才重新下载，避免频繁的请求和资源传输。

如果在 nginx 什么也不配置默认使用的是协商缓存，也可以理解为 no-cache；
```



### CDN 缓存（以阿里云 CND 为例）

#### **如何判断**CDN缓存是否成功

通过检查HTTP响应头中的相关字段来判断

1. `X-Cache`: 表示请求是否命中CDN缓存。值为 **HIT **表示命中，**MISS** 或者字段不存在表示未命中。
2. `Age`: 表示文件在CDN节点上缓存的时间（秒）。文件被刷新或首次访问无此字段。`Age`为0表示缓存过期，需回源校验。
3. `X-Swift-CacheTime`: 表示文件在CDN节点上的允许缓存时间。计算剩余缓存时间：`X-Swift-CacheTime `– `Age`。
4. `X-Swift-SaveTime`：表示资源首次被缓存到CDN节点上的时间（GMT）。转换为中国北京时间需加上8小时。



### service worker 缓存

PWA 的服务端会有个 sw.js 文件，这里面包含了网站的所有静态资源，service worker 会根据 sw.js 去拉取静态资源进行缓存；

当 PWA 网站配置 CDN 时需要注意，和 html 一样不要将 sw.js 缓存到 CDN，如果缓存了会导致网站所需要的静态资源和 sw.js 中声明和缓存的静态资源不一致

