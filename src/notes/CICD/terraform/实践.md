# 实践

常用命令

```
# 初始化 Terraform
terraform init

# 检查计划文件格式
terraform validate

# 检查并展示计划变更内容
terraform play

# 检查并生成计划文件，如果你不加 -out，Terraform 会再次重新计算一次计划内容，结果可能会不完全一致（比如云资源状态变了、某些数据源有更新）。	
terraform play -out plan.tfplan

# 加载环境变量
terraform apply  -var="staticvmname=$1" -var="network_ip=$2"

# 执行计划
terraform apply

# 自动确认
terraform apply -auto-approve
# 执行指定计划文件的计划
terraform apply plan.tfplan

# 加载对应变量文件
terraform apply -var-file="prod.tfvars"

# 销毁资源
terraform destroy

# 查看即将被销毁的资源 
terraform plan -destroy

# 销毁一部分资源 
直接编辑 tf 文件删除某个资源，然后 apply 也相当于销毁了这个资源
```

实例 1：

```
├── main.tf # 主文件
├── plan.tfplan # -out 输出文件
├── terraform.tfstate # 执行后的状态文件
├── terraform.tfstate.backup # 上一次执行的状态文件备份
├── terraform.tfvars # 默认自动加载的变量文件
└── variables.tf # 声明变量的文件
└── backend.tf # 配置远端存储 state，比如 S3

```



其他

```
##  关于密钥信息传入
方式1：xx.auto.tfvars  
敏感信息可以写入此文件，并加入 .gitignore 防止上传到仓库；Terraform 会自动加载 *.auto.tfvars 文件

方式2：使用环境变量传递变量值
export TF_VAR_db_password="SuperSecret123!"
terraform apply

方式3：terraform.tfvars
如果只有密钥变量可以使用，但是要确保该文件不纳入版本控制

```











复杂项目目录结构示例：

```
terraform-project/
├── environments/
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── terraform.tfvars
│   │   └── backend.tf       # 存放远程 state 配置
│   ├── staging/
│   │   └── ...
│   └── prod/
│       └── ...
│
├── modules/
│   ├── vpc/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── eks/
│   ├── rds/
│   └── alb/
│
├── global/
│   └── s3_backend_bootstrap/  # 用 Terraform 部署存 state 的 S3 + DynamoDB
│
├── scripts/
│   └── wrapper.sh           # 提供统一入口，比如 `./apply.sh dev`
│
├── .terraform.lock.hcl
├── README.md
└── versions.tf              # 统一定义 provider & Terraform 版本
```



## Terraform State

Terraform State 是指 Terraform 状态，是 Terraform 生命周期过程中必不可少的元素。本质上讲，Terraform 状态是你的基础设施配置的元数据存储库，Terraform 把它管理的资源状态保存在一个状态文件中。

默认情况下，状态保存在一个名为 "terraform.tfstate" 的文件中，但也可以远程存储，在团队协作管理基础设施的场景下，推荐采用远程存储。

Terraform 使用状态来创建执行计划并更改您的基础设施。在任何操作之前，Terraform 会执行刷新操作以用基础设施的实际状态来更新状态。Terraform 状态的主要目的是存储远端系统（如云上）中的基础设施对象和配置文件中声明的资源实例之间的绑定关系，当 Terraform 通过配置文件创建或者更改了远端对象时，它会将该远端对象的标识记录在与之对应的资源实例中，并保存在状态文件中，之后，Terraform 可能会根据未来的配置更改更新或删除该对象。

### 使用远端状态存储

1. **远端状态文件会自动更新**

   当远程存储时，状态文件会自动更新，即一旦配置了远程后端，每次运行 plan 或 apply 命令时，Terraform 将自动从远端加载状态文件。除此之外，它还会在每次 apply 后自动将状态文件同步存储在远端中，因此不存在手动错误的情况。

2. **远端状态文件支持状态锁定**

   当执行 Terraform 命令时，可以对远端状态文件进行加锁，这样如果多个开发人员同时运行 terraform apply，它不会因同时更新而损坏。

3. **远端状态文件存储比本地存储更安全**

   OSS Bucket 支持本地传输加密和远端加密功能。此外，OSS Bucket 包括多种配置访问权限的方法，因此你可以以精细化的方式控制状态文件的访问权限。



### 最佳实践参考

https://cloud.google.com/docs/terraform/best-practices-for-terraform?hl=zh-cn





### 参考

https://developer.hashicorp.com/terraform

https://www.cnblogs.com/Sunzz/p/18498915

https://help.aliyun.com/zh/terraform/introduction-to-terraform-state?spm=a2c4g.11186623.help-menu-95817.d_3_1_0.6ef1673dDipe2n&scm=20140722.H_2837060._.OR_help-T_cn~zh-V_1

